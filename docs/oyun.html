// ... (Firebase ayarları aynı)

var myID = localStorage.getItem("turnuva_id"), myName = "", myTeam = "", activeID = "";

db.ref("turnuva/oyuncular/" + myID).on("value", s => {
    if(!s.exists()) { window.location.href = "index.html"; return; }
    myName = s.val().ad;
    myTeam = s.val().takim || s.val().ad;
    document.getElementById("bilgi").innerText = myTeam;
    if(s.val().durum === "bekliyor") window.location.href = "index.html"; 
});

db.ref("turnuva/maclar").on("value", s => {
    if(!s.exists()) return;
    s.forEach(m => {
        var v = m.val();
        var katildi = (v.tip === "duello") ? (v.p1 === myID || v.p2 === myID) : (v.skorlar && v.skorlar.hasOwnProperty(myTeam));
        
        if(katildi) {
            activeID = m.key;
            // Bireysel ilerlemeyi alalım
            var benimRaunt = (v.tip === "duello") ? (v.p1 === myID ? v.p1_ilerleme : v.p2_ilerleme) : v.ilerleme[myTeam];
            
            // Eğer benim kelimelerim bittiyse
            if(benimRaunt >= v.kelimeler.length) {
                document.getElementById("oyunAlan").style.display = "none";
                document.getElementById("bittiEkrani").style.display = "block";
            } else {
                document.getElementById("oyunAlan").style.display = "block";
                document.getElementById("bittiEkrani").style.display = "none";
                document.getElementById("kelime").innerText = v.kelimeler[benimRaunt].gizli;
                document.getElementById("ipucu").innerText = v.kelimeler[benimRaunt].i;
                document.getElementById("skor").innerText = "Puan: " + (v.tip === "duello" ? (v.p1 === myID ? v.p1_skor : v.p2_skor) : v.skorlar[myTeam]);
            }
        }
    });
});

function gonder() {
    var t = document.getElementById("tahmin").value.toUpperCase().trim();
    document.getElementById("tahmin").value = "";
    if(!t || !activeID) return;

    db.ref("turnuva/maclar/" + activeID).transaction(mac => {
        if(!mac) return mac;
        
        // Benim ilerlemem hangisi?
        var r;
        if(mac.tip === "duello") {
            r = (mac.p1 === myID) ? mac.p1_ilerleme : mac.p2_ilerleme;
        } else {
            r = mac.ilerleme[myTeam];
        }

        // Kelime doğru mu?
        if(t === mac.kelimeler[r].k) {
            if(mac.tip === "duello") {
                if(mac.p1 === myID) { mac.p1_skor++; mac.p1_ilerleme++; }
                else { mac.p2_skor++; mac.p2_ilerleme++; }
            } else {
                mac.skorlar[myTeam]++;
                mac.ilerleme[myTeam]++; // Sadece benim raunt ilerler
            }
        }
        return mac;
    });
}
