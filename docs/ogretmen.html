<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>YÃ¶netici Paneli</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flex { display: flex; gap: 20px; }
        .col { flex: 1; }
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; color: white; margin: 3px; }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-green { background: #2ecc71; }
        .btn-orange { background: #f39c12; }
        .btn-black { background: #2c3e50; }
        .list-box { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff; border-radius: 5px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .score-box { background: #34495e; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 15px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ‘¨â€ğŸ« Ã–ÄŸretmen Kontrol Paneli</h2>
        <label>Mod SeÃ§imi: </label>
        <select id="mod" style="padding:8px; border-radius:5px;">
            <option value="grup">ğŸ† Grup AÅŸamasÄ± (Otomatik DaÄŸÄ±t)</option>
            <option value="savas">ğŸ° TakÄ±m SavaÅŸÄ± (Ã–ÄŸrenci Kaptan SeÃ§er)</option>
            <option value="duello">âš”ï¸ DÃ¼ello (Teke Tek EÅŸleÅŸtir)</option>
        </select>
        &nbsp;|&nbsp;
        Kelime Adedi: <input type="number" id="kAdet" value="5" style="width:50px; padding:5px;">
        HÄ±z (Sn): <input type="number" id="hiz" value="10" style="width:50px; padding:5px;">
        <br><br>
        <button class="btn-blue" onclick="baslat()">ğŸš€ GRUPLARI KUR VE OYUNU BAÅLAT</button>
        <button class="btn-orange" onclick="maciBitir()">â¹ï¸ MAÃ‡I BÄ°TÄ°R (Kelimeler Silinmez)</button>
        <button class="btn-black" onclick="sistemiSifirla()">ğŸ§¹ SÄ°STEMÄ° KOMPLE SIFIRLA</button>
    </div>

    <div class="flex">
        <div class="col card">
            <h3>ğŸ“Š CanlÄ± Skorlar ve Gruplar</h3>
            <div id="canliSkorlar" class="list-box" style="background:#ecf0f1;">MaÃ§ bekleniyor...</div>
        </div>
        
        <div class="col card">
            <h3>ğŸ‘¥ Ã–ÄŸrenci Listesi</h3>
            <div id="onayListesi" class="list-box"></div>
        </div>
        
        <div class="col card">
            <h3>ğŸ“š Kelime Havuzu</h3>
            <input id="k" placeholder="Kelime" style="padding:8px; width:40%;"> 
            <input id="a" placeholder="Ä°pucu" style="padding:8px; width:40%;">
            <button class="btn-green" onclick="kelimeEkle()">EKLE</button>
            <div id="havuzListesi" class="list-box" style="margin-top:10px;"></div>
        </div>
    </div>

    <script>
        var firebaseConfig = { apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4", authDomain: "kelime-avi-bec9f.firebaseapp.com", databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com", projectId: "kelime-avi-bec9f", storageBucket: "kelime-avi-bec9f.appspot.com", messagingSenderId: "154681825331", appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46" };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        // 1. KELÄ°ME YÃ–NETÄ°MÄ°
        function kelimeEkle() {
            var k = document.getElementById("k").value.toUpperCase().trim();
            var a = document.getElementById("a").value.trim();
            if(k && a) {
                db.ref("turnuva/havuz").push({ k: k, a: a });
                document.getElementById("k").value = "";
                document.getElementById("a").value = "";
            }
        }

        db.ref("turnuva/havuz").on("value", s => {
            var h = "";
            s.forEach(x => {
                h += `<div class="item">
                        <span><b>${x.val().k}</b> - ${x.val().a}</span> 
                        <button class="btn-red" style="padding:5px 10px;" onclick="db.ref('turnuva/havuz/${x.key}').remove()">SÄ°L</button>
                      </div>`;
            });
            document.getElementById("havuzListesi").innerHTML = h;
        });

        // 2. Ã–ÄRENCÄ° YÃ–NETÄ°MÄ°
        db.ref("turnuva/oyuncular").on("value", s => {
            var h = ""; 
            window.onaylilar = [];
            s.forEach(o => {
                var d = o.val();
                if(d.durum === "onay_bekliyor") {
                    h += `<div class="item">${d.ad} <button class="btn-green" style="padding:5px 10px;" onclick="db.ref('turnuva/oyuncular/${o.key}/durum').set('bekliyor')">Onayla</button></div>`;
                } else {
                    h += `<div class="item">${d.ad} âœ… OnaylandÄ±</div>`;
                    window.onaylilar.push({ id: o.key, ad: d.ad });
                }
            });
            document.getElementById("onayListesi").innerHTML = h;
        });

        // 3. CANLI SKOR GÃ–RÃœNÃœMÃœ
        db.ref("turnuva/maclar").on("value", s => {
            var h = "";
            s.forEach(m => {
                var v = m.val();
                h += `<div class="score-box"><strong>ğŸ“Œ ${m.key} (${v.tip.toUpperCase()})</strong><br><hr style="border-color:#7f8c8d; margin:5px 0;">`;
                
                if(v.tip === "duello") {
                    h += `âš”ï¸ ${v.p1_ad}: ${v.p1_skor} Puan <br>âš”ï¸ ${v.p2_ad}: ${v.p2_skor} Puan`;
                } else {
                    for(let tAd in v.skorlar) {
                        if(tAd !== "SÄ°STEM") {
                            h += `ğŸš© <b>${tAd}:</b> ${v.skorlar[tAd]} Puan<br>`;
                        }
                    }
                }
                h += `</div>`;
            });
            document.getElementById("canliSkorlar").innerHTML = h || "Åu an aktif bir maÃ§ bulunmuyor.";
        });

        // 4. OYUNU BAÅLATMA MANTIÄI
        function baslat() {
            var mod = document.getElementById("mod").value;
            var kAdet = parseInt(document.getElementById("kAdet").value);
            
            db.ref("turnuva/havuz").once("value", hs => {
                if(!hs.exists()) return alert("LÃ¼tfen Ã¶nce kelime havuzuna kelime ekleyin!");
                
                // Kelimeleri karÄ±ÅŸtÄ±r ve seÃ§
                var havuz = []; 
                hs.forEach(x => havuz.push(x.val())); 
                havuz.sort(() => 0.5 - Math.random());
                var kels = havuz.slice(0, kAdet).map(x => ({k: x.k, i: x.a, gizli: x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g, "-")}));
                
                // Ã–ÄŸrencileri karÄ±ÅŸtÄ±r
                var liste = window.onaylilar.sort(() => 0.5 - Math.random());
                if(liste.length === 0) return alert("OnaylÄ± Ã¶ÄŸrenci bulunmuyor!");

                if(mod === "grup") {
                    let grupSayisi = Math.ceil(liste.length / 4);
                    for(let i=0; i < grupSayisi; i++) {
                        let uyeler = liste.slice(i*4, (i*4)+4);
                        let sk = {};
                        uyeler.forEach(x => { 
                            sk[x.ad] = 0; // Skorda ismi yazsÄ±n
                            db.ref("turnuva/oyuncular/" + x.id).update({durum: "eslesti", takim: x.ad}); 
                        });
                        db.ref("turnuva/maclar/Grup-" + (i+1)).set({ tip: "grup", durum: "aktif", aktifRaunt: 0, kelimeler: kels, skorlar: sk });
                    }
                } 
                else if(mod === "savas") {
                    db.ref("turnuva/maclar/Takim-Savasi").set({ tip: "savas", durum: "aktif", aktifRaunt: 0, kelimeler: kels, skorlar: {"SÄ°STEM": 0} });
                    window.onaylilar.forEach(o => db.ref("turnuva/oyuncular/" + o.id + "/durum").set("takim_secme_ekrani"));
                } 
                else if(mod === "duello") {
                    for(let i=0; i < liste.length; i+=2) {
                        if(liste[i+1]) { // EÄŸer eÅŸleÅŸecek ikinci kiÅŸi varsa
                            db.ref("turnuva/maclar/Duello-" + ((i/2)+1)).set({ 
                                tip: "duello", durum: "aktif", 
                                p1: liste[i].id, p1_ad: liste[i].ad, 
                                p2: liste[i+1].id, p2_ad: liste[i+1].ad, 
                                p1_skor: 0, p2_skor: 0, 
                                aktifRaunt: 0, kelimeler: kels 
                            });
                            db.ref("turnuva/oyuncular/" + liste[i].id).update({durum: "eslesti", takim: liste[i].ad});
                            db.ref("turnuva/oyuncular/" + liste[i+1].id).update({durum: "eslesti", takim: liste[i+1].ad});
                        }
                    }
                }
                
                motorBaslat();
            });
        }

        // KELÄ°ME AÃ‡MA MOTORU
        function motorBaslat() {
            var hz = parseInt(document.getElementById("hiz").value);
            if(window.mtr) clearInterval(window.mtr);
            
            window.mtr = setInterval(() => {
                db.ref("turnuva/maclar").once("value", s => {
                    s.forEach(ms => {
                        var m = ms.val();
                        if(m.durum === "aktif") {
                            var r = m.aktifRaunt;
                            var g = m.kelimeler[r].gizli;
                            var k = m.kelimeler[r].k;
                            
                            var tireler = [];
                            for(let i=0; i<g.length; i++) if(g[i] === "-") tireler.push(i);
                            
                            if(tireler.length > 1) { // Son harfi bÄ±rak ki bilebilsinler
                                var secilenIndex = tireler[Math.floor(Math.random() * tireler.length)];
                                var yeniGizli = g.split("");
                                yeniGizli[secilenIndex] = k[secilenIndex];
                                db.ref(`turnuva/maclar/${ms.key}/kelimeler/${r}/gizli`).set(yeniGizli.join(""));
                            }
                        }
                    });
                });
            }, hz * 1000);
        }

        // 5. BÄ°TÄ°RME VE SIFIRLAMA
        function maciBitir() {
            if(confirm("Mevcut maÃ§lar kapatÄ±lacak (Kelimeler ve Ã¶ÄŸrenciler kalacak). Emin misiniz?")) {
                db.ref("turnuva/maclar").remove();
            }
        }

        function sistemiSifirla() {
            if(confirm("DÄ°KKAT! TÃ¼m Ã¶ÄŸrenciler, kelimeler ve skorlar silinecek. Emin misiniz?")) {
                db.ref("turnuva").remove();
                location.reload();
            }
        }
    </script>
</body>
</html>
