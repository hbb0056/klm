// ... (Firebase ayarları ve diğer kısımlar aynı)

function baslat(tip) {
    db.ref("turnuva/havuz").once("value", hs => {
        if(!hs.exists()) return alert("Kelime havuzu boş!");
        var hav = []; hs.forEach(x => hav.push(x.val())); hav.sort(() => 0.5 - Math.random());
        var kels = hav.slice(0, document.getElementById("kAdet").value).map(x => ({k:x.k, i:x.a, gizli:x.k.replace(/[A-ZÇĞİÖŞÜ]/g,"-")}));
        var l = window.onaylilar.sort(() => 0.5 - Math.random());
        
        db.ref("turnuva/maclar").remove();

        if(l.length <= 2 && l.length > 0) {
            // Final veya tek grup varsa Düello formatı
            db.ref("turnuva/maclar/FINAL").set({ 
                tip:"duello", durum:"aktif", p1:l[0].id, p1_ad:l[0].ad, p2:l[1].id, p2_ad:l[1].ad, 
                p1_skor:0, p2_skor:0, p1_ilerleme:0, p2_ilerleme:0, kelimeler:kels 
            });
            l.forEach(x => db.ref("turnuva/oyuncular/"+x.id).update({durum:"eslesti", takim:x.ad}));
        } else {
            // Grup Formatı
            for(let i=0; i < Math.ceil(l.length/4); i++) {
                let u = l.slice(i*4, (i*4)+4);
                let sk = {}, il = {};
                u.forEach(x => { 
                    sk[x.ad] = 0; 
                    il[x.ad] = 0; // Herkesin raundu 0'dan başlar
                    db.ref("turnuva/oyuncular/"+x.id).update({durum:"eslesti", takim:x.ad}); 
                });
                db.ref("turnuva/maclar/Grup-"+(i+1)).set({ 
                    tip:"grup", durum:"aktif", kelimeler:kels, skorlar:sk, ilerleme:il 
                });
            }
        }
        motor();
    });
}

// Harf açma motoru artık sadece kelimelerin gizli hallerini günceller
function motor() {
    var hz = document.getElementById("hiz").value; if(window.mtr) clearInterval(window.mtr);
    window.mtr = setInterval(() => {
        db.ref("turnuva/maclar").once("value", s => { s.forEach(ms => {
            var m = ms.val(); if(m.durum === "aktif") {
                // Her kelime için rastgele bir harf açalım (tüm rauntlardaki kelimeler için)
                m.kelimeler.forEach((kel, idx) => {
                    var g = kel.gizli, k = kel.k, t = [];
                    for(let i=0; i<g.length; i++) if(g[i]==="-") t.push(i);
                    if(t.length > 1) {
                        var sc = t[Math.floor(Math.random()*t.length)];
                        var y = g.split(""); y[sc] = k[sc];
                        db.ref(`turnuva/maclar/${ms.key}/kelimeler/${idx}/gizli`).set(y.join(""));
                    }
                });
            }
        }); });
    }, hz * 1000);
}
