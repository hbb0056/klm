<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>YÃ¶netim Paneli</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flex { display: flex; gap: 20px; }
        .col { flex: 1; }
        button { cursor: pointer; padding: 10px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .list-box { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; background: #fafafa; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        h4 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .tag { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; color: white; }
    </style>
</head>
<body>
    <h1>ğŸŸï¸ Turnuva YÃ¶netim Merkezi</h1>

    <div class="flex">
        <div class="col">
            <div class="card">
                <h3>ğŸ‘¥ Oyuncu DurumlarÄ±</h3>
                <div id="oyuncuListesi" class="list-box"></div>
            </div>
        </div>

        <div class="col">
            <div class="card">
                <h3>ğŸ“š Kelime Havuzu</h3>
                <div id="ihtiyac" style="padding:10px; margin-bottom:10px; border-radius:8px; font-weight:bold;">HesaplanÄ±yor...</div>
                <div class="flex">
                    <input id="k" placeholder="Kelime" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <input id="a" placeholder="Ä°pucu" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <button class="btn-green" onclick="ekle()">EKLE</button>
                </div>
                <div id="kelimeHavuzu" class="list-box"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>âš™ï¸ Turnuva Kontrolleri</h3>
        <label>Harf Ä°pucu HÄ±zÄ± (Saniye): </label>
        <input type="number" id="sn" value="10" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:5px;">
        <button class="btn-blue" style="font-size:1.2em; padding:10px 30px;" onclick="baslat()">âš”ï¸ TURU BAÅLAT</button>
        <button class="btn-red" onclick="sifirla()">ğŸ§¹ SÄ°STEMÄ° SIFIRLA</button>
    </div>

    <div class="card">
        <h3>ğŸ“Š CanlÄ± & Biten MaÃ§lar</h3>
        <div id="macListesi"></div>
    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
            authDomain: "kelime-avi-bec9f.firebaseapp.com",
            databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
            projectId: "kelime-avi-bec9f",
            storageBucket: "kelime-avi-bec9f.appspot.com",
            messagingSenderId: "154681825331",
            appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var hInterval;

        function ekle() {
            var k = document.getElementById("k").value.toUpperCase().trim();
            var a = document.getElementById("a").value.trim();
            if(k && a) db.ref("turnuva/havuz").push({k, a});
            document.getElementById("k").value=""; document.getElementById("a").value="";
        }

        db.ref("turnuva/havuz").on("value", s => {
            var html = ""; window.havuzSayisi = s.numChildren();
            s.forEach(h => {
                html += `<div class="item"><span><b>${h.val().k}</b> - ${h.val().a}</span> <button class="btn-red" style="padding:4px" onclick="db.ref('turnuva/havuz/${h.key}').remove()">X</button></div>`;
            });
            document.getElementById("kelimeHavuzu").innerHTML = html || "Havuz boÅŸ.";
            ihtiyacHesapla();
        });

        db.ref("turnuva/oyuncular").on("value", s => {
            var onayHtml = "<h4>â³ Onay Bekleyenler</h4>";
            var ustHtml = "<h4>ğŸš€ Ãœst Grup (Kazananlar/Aktif)</h4>";
            var altHtml = "<h4>ğŸ’€ Alt Grup (Elenenler)</h4>";
            window.onayliCount = 0;

            s.forEach(o => {
                var d = o.val();
                var item = `<div class="item"><span>${d.ad}</span>`;
                if(d.durum === "onay_bekliyor") {
                    onayHtml += item + `<button class="btn-green" onclick="db.ref('turnuva/oyuncular/${o.key}/durum').set('bekliyor')">ONAYLA</button></div>`;
                } else if(d.durum === "bekliyor" || d.durum === "eslesti") {
                    window.onayliCount++;
                    ustHtml += item + `<span class="tag" style="background:#2ecc71">AKTÄ°F</span></div>`;
                } else if(d.durum === "elendi") {
                    altHtml += item + `<span class="tag" style="background:#e74c3c">ELENDÄ°</span></div>`;
                }
            });
            document.getElementById("oyuncuListesi").innerHTML = onayHtml + ustHtml + altHtml;
            ihtiyacHesapla();
        });

        function ihtiyacHesapla() {
            var ger = Math.floor(window.onayliCount / 2) * 3;
            var box = document.getElementById("ihtiyac");
            if(window.havuzSayisi < ger) {
                box.innerText = `âš ï¸ Kelime Eksik! LazÄ±m: ${ger}, Mevcut: ${window.havuzSayisi}`;
                box.style.background = "#fff3cd";
            } else {
                box.innerText = `âœ… HazÄ±r! ${window.onayliCount} oyuncu iÃ§in ${window.havuzSayisi} kelime yeterli.`;
                box.style.background = "#d4edda";
            }
        }

        function baslat() {
            db.ref("turnuva").once("value", ts => {
                var havuz = []; ts.child("havuz").forEach(h => { havuz.push(h.val()); });
                havuz = havuz.sort(() => 0.5 - Math.random());
                var bekleyenler = []; ts.child("oyuncular").forEach(o => { if(o.val().durum === "bekliyor") bekleyenler.push({id:o.key, ad:o.val().ad}); });

                if(bekleyenler.length < 2) return alert("EÅŸleÅŸecek yeterli oyuncu yok!");
                if(havuz.length < Math.floor(bekleyenler.length/2)*3) return alert("Havuzdaki kelime sayÄ±sÄ± yetersiz!");

                var kIdx = 0;
                for(let i=0; i<bekleyenler.length; i+=2) {
                    if(bekleyenler[i+1]) {
                        var p1 = bekleyenler[i], p2 = bekleyenler[i+1];
                        var mKelimeler = havuz.slice(kIdx, kIdx+3).map(x => ({k:x.k, i:x.a, gizli:x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g, "-")}));
                        kIdx += 3;
                        db.ref("turnuva/maclar").push().set({
                            p1:p1.id, p2:p2.id, p1_ad:p1.ad, p2_ad:p2.ad,
                            kelimeler:mKelimeler, aktifRaunt:0, p1_skor:0, p2_skor:0, durum:"aktif", winner:""
                        });
                        db.ref("turnuva/oyuncular/"+p1.id+"/durum").set("eslesti");
                        db.ref("turnuva/oyuncular/"+p2.id+"/durum").set("eslesti");
                    }
                }
                harfMotorunuBaslat();
            });
        }

        function harfMotorunuBaslat() {
            if(hInterval) clearInterval(hInterval);
            var sn = document.getElementById("sn").value || 10;
            hInterval = setInterval(() => {
                db.ref("turnuva/maclar").once("value", s => {
                    s.forEach(ms => {
                        var m = ms.val();
                        if(m.durum === "aktif") {
                            var r = m.aktifRaunt;
                            var g = m.kelimeler[r].gizli, k = m.kelimeler[r].k;
                            var tireler = [];
                            for(let i=0; i<g.length; i++) if(g[i]==="-") tireler.push(i);
                            if(tireler.length > 1) {
                                var sec = tireler[Math.floor(Math.random()*tireler.length)];
                                var yeni = g.split(""); yeni[sec] = k[sec];
                                db.ref(`turnuva/maclar/${ms.key}/kelimeler/${r}/gizli`).set(yeni.join(""));
                            }
                        }
                    });
                });
            }, sn * 1000);
        }

        db.ref("turnuva/maclar").on("value", s => {
            var aktifH = "<h4>ğŸ”¥ Devam Edenler</h4>", bitenH = "<h4>ğŸ SonuÃ§lar</h4>";
            s.forEach(m => {
                var v = m.val();
                if(v.durum === "aktif") aktifH += `<div class="item">${v.p1_ad} vs ${v.p2_ad} [R:${v.aktifRaunt+1}]</div>`;
                else bitenH += `<div class="item">ğŸ† ${v.winner===v.p1?v.p1_ad:v.p2_ad} kazandÄ± (${v.p1_skor}-${v.p2_skor})</div>`;
            });
            document.getElementById("macListesi").innerHTML = aktifH + bitenH;
        });

        function sifirla() { if(confirm("TÃ¼m turnuva ve oyuncular silinsin mi?")) { db.ref("turnuva").remove(); location.reload(); } }
    </script>
</body>
</html>
