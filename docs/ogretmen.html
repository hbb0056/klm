<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>GeliÅŸmiÅŸ YÃ¶netim Merkezi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flex { display: flex; gap: 20px; }
        .col { flex: 1; }
        button { cursor: pointer; padding: 10px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .nav-bar { background: #16213e; color: white; padding: 15px; display: flex; justify-content: space-between; border-radius: 0 0 15px 15px; }
        .list-box { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .mode-selector { background: #ebf3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px dashed #3498db; }
        input[type="number"] { width: 50px; padding: 5px; }
        .ana-ozel { display: none; }
    </style>
</head>
<body>
    <script>
        var rol = sessionStorage.getItem("adminRole");
        if(!rol) window.location.href = "login.html";
    </script>

    <div class="nav-bar">
        <div id="rol-etiket"></div>
        <button class="btn-red" onclick="sessionStorage.clear(); window.location.href='login.html';">Ã‡Ä±kÄ±ÅŸ</button>
    </div>

    <div class="mode-selector">
        <strong>ğŸ® OYUN MODU SEÃ‡Ä°N:</strong>
        <select id="gameMode" onchange="modDegisti()">
            <option value="duello">Klasik DÃ¼ello (Teke Tek Elenme)</option>
            <option value="grup">Grup AÅŸamasÄ± (En Ä°yi 2 Ãœst Tura Ã§Ä±kar)</option>
        </select>
        <span id="grupAyari" style="display:none; margin-left:20px;">
            Grup Kelime SayÄ±sÄ±: <input type="number" id="grupKelime" value="5">
        </span>
        <span id="duelloAyari" style="margin-left:20px;">
            DÃ¼ello Kelime SayÄ±sÄ±: <input type="number" id="duelloKelime" value="3">
        </span>
    </div>

    <div class="flex">
        <div class="col">
            <div class="card">
                <h3>ğŸ‘¥ Oyuncu YÃ¶netimi</h3>
                <div id="oyuncuListesi" class="list-box"></div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <h3>ğŸ“š Kelime Havuzu</h3>
                <div id="ihtiyac" style="font-size:12px; color:#666"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input id="k" placeholder="Kelime" style="flex:1;">
                    <input id="a" placeholder="Ä°pucu" style="flex:1;">
                    <button class="btn-green" onclick="ekle()">EKLE</button>
                </div>
                <div id="kelimeHavuzu" class="list-box" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸš€ Turnuva KontrolÃ¼</h3>
        <div class="flex" style="align-items: center;">
            <span>Harf HÄ±zÄ± (sn):</span>
            <input type="number" id="sn" value="10">
            <button class="btn-blue" onclick="turnuvayiBaslat()">âš”ï¸ TURU BAÅLAT</button>
            <button class="btn-red" onclick="maclariSifirla()">MaÃ§larÄ± Temizle</button>
            <button class="ana-ozel btn-red" style="background:black" onclick="herseyiSifirla()">Her Åeyi Sil</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š CanlÄ± Gruplar ve MaÃ§lar</h3>
        <div id="macListesi"></div>
    </div>

    <script>
        var role = sessionStorage.getItem("adminRole");
        document.getElementById("rol-etiket").innerText = (role === "ANA") ? "ğŸ‘‘ BAÅ YÃ–NETÄ°CÄ°: HABÄ°P" : "ğŸ‘¨â€ğŸ« MÄ°SAFÄ°R";
        if(role === "ANA") document.querySelectorAll(".ana-ozel").forEach(el => el.style.display="inline-block");

        var firebaseConfig = {
            apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
            authDomain: "kelime-avi-bec9f.firebaseapp.com",
            databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
            projectId: "kelime-avi-bec9f",
            storageBucket: "kelime-avi-bec9f.appspot.com",
            messagingSenderId: "154681825331",
            appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        var harfMotoru;

        function modDegisti() {
            var mode = document.getElementById("gameMode").value;
            document.getElementById("grupAyari").style.display = (mode === "grup") ? "inline" : "none";
            document.getElementById("duelloAyari").style.display = (mode === "duello") ? "inline" : "none";
        }

        // KELÄ°ME VE OYUNCU LÄ°STELEME (AynÄ± MantÄ±k)
        function ekle() {
            var k = document.getElementById("k").value.toUpperCase().trim();
            var a = document.getElementById("a").value.trim();
            if(k && a) db.ref("turnuva/havuz").push({k, a});
            document.getElementById("k").value=""; document.getElementById("a").value="";
        }

        db.ref("turnuva/havuz").on("value", s => {
            var h = ""; s.forEach(x => { h += `<div class="item"><span><b>${x.val().k}</b></span><button class="btn-red" onclick="db.ref('turnuva/havuz/${x.key}').remove()">X</button></div>`; });
            document.getElementById("kelimeHavuzu").innerHTML = h;
        });

        db.ref("turnuva/oyuncular").on("value", s => {
            var h = ""; window.bekleyenler = [];
            s.forEach(x => {
                var d = x.val();
                if(d.durum === "onay_bekliyor") h += `<div class="item">${d.ad}<button class="btn-green" onclick="db.ref('turnuva/oyuncular/${x.key}/durum').set('bekliyor')">Onayla</button></div>`;
                else if(d.durum === "bekliyor") {
                    window.bekleyenler.push({id:x.key, ad:d.ad});
                    h += `<div class="item">${d.ad} <span style="color:green">HAZIR</span></div>`;
                }
            });
            document.getElementById("oyuncuListesi").innerHTML = h;
        });

        // TURNUVA BAÅLATMA MANTIÄI (GRUP VEYA DÃœELLO)
        function turnuvayiBaslat() {
            var mode = document.getElementById("gameMode").value;
            db.ref("turnuva/havuz").once("value", hs => {
                var havuz = []; hs.forEach(h => { havuz.push(h.val()); });
                havuz = havuz.sort(() => 0.5 - Math.random());
                
                if(window.bekleyenler.length < 2) return alert("Yetersiz oyuncu!");

                if(mode === "grup") {
                    // GRUP MODU: 4'erli veya 3'erli gruplara bÃ¶l
                    var oyuncular = window.bekleyenler.sort(() => 0.5 - Math.random());
                    var grupSayisi = Math.ceil(oyuncular.length / 4);
                    var kelimeSayisi = parseInt(document.getElementById("grupKelime").value);
                    
                    var kIdx = 0;
                    for(let i=0; i<grupSayisi; i++) {
                        var grupUyeleri = oyuncular.slice(i*4, (i+1)*4);
                        var grupKelimeleri = havuz.slice(kIdx, kIdx + kelimeSayisi).map(x => ({k:x.k, i:x.a, gizli:x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g, "-")}));
                        kIdx += kelimeSayisi;
                        
                        var macRef = db.ref("turnuva/maclar").push();
                        macRef.set({
                            tip: "grup",
                            uyeler: grupUyeleri,
                            kelimeler: grupKelimeleri,
                            aktifRaunt: 0,
                            skorlar: {}, // {oyuncuId: puan}
                            durum: "aktif"
                        });
                        grupUyeleri.forEach(u => db.ref("turnuva/oyuncular/"+u.id+"/durum").set("eslesti"));
                    }
                } else {
                    // DÃœELLO MODU (Senin eski sistemin)
                    var kIdx = 0; var kSayi = parseInt(document.getElementById("duelloKelime").value);
                    for(let i=0; i<window.bekleyenler.length; i+=2) {
                        if(window.bekleyenler[i+1]) {
                            var p1 = window.bekleyenler[i], p2 = window.bekleyenler[i+1];
                            var mk = havuz.slice(kIdx, kIdx+kSayi).map(x => ({k:x.k, i:x.a, gizli:x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g, "-")}));
                            kIdx += kSayi;
                            db.ref("turnuva/maclar").push().set({ tip:"duello", p1:p1.id, p2:p2.id, p1_ad:p1.ad, p2_ad:p2.ad, kelimeler:mk, aktifRaunt:0, p1_skor:0, p2_skor:0, durum:"aktif" });
                            db.ref("turnuva/oyuncular/"+p1.id+"/durum").set("eslesti");
                            db.ref("turnuva/oyuncular/"+p2.id+"/durum").set("eslesti");
                        }
                    }
                }
                motorBaslat();
            });
        }

        function motorBaslat() {
            if(harfMotoru) clearInterval(harfMotoru);
            var sn = document.getElementById("sn").value;
            harfMotoru = setInterval(() => {
                db.ref("turnuva/maclar").once("value", s => {
                    s.forEach(ms => {
                        var m = ms.val();
                        if(m.durum === "aktif") {
                            var r = m.aktifRaunt;
                            var g = m.kelimeler[r].gizli, k = m.kelimeler[r].k;
                            var t = []; for(let i=0; i<g.length; i++) if(g[i]==="-") t.push(i);
                            if(t.length > 1) {
                                var sec = t[Math.floor(Math.random()*t.length)];
                                var yeni = g.split(""); yeni[sec] = k[sec];
                                db.ref(`turnuva/maclar/${ms.key}/kelimeler/${r}/gizli`).set(yeni.join(""));
                            }
                        }
                    });
                });
            }, sn * 1000);
        }

        db.ref("turnuva/maclar").on("value", s => {
            var h = ""; s.forEach(m => {
                var v = m.val();
                if(v.tip === "grup") h += `<div class="item"><b>Grup MaÃ§Ä±:</b> ${v.uyeler.map(u=>u.ad).join(", ")} [${v.durum}]</div>`;
                else h += `<div class="item"><b>DÃ¼ello:</b> ${v.p1_ad} vs ${v.p2_ad} [${v.durum}]</div>`;
            });
            document.getElementById("macListesi").innerHTML = h;
        });

        function maclariSifirla() { db.ref("turnuva/maclar").remove(); db.ref("turnuva/oyuncular").once("value", s => { s.forEach(x => { if(x.val().durum !== "onay_bekliyor") db.ref("turnuva/oyuncular/"+x.key+"/durum").set("bekliyor"); })}); }
        function herseyiSifirla() { if(confirm("Her ÅŸey silinsin mi?")) db.ref("turnuva").remove(); }
    </script>
</body>
</html>
