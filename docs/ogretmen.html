<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ã–ÄŸretmen - Turnuva Kontrol</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flex { display: flex; gap: 20px; }
        .column { flex: 1; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .alert { padding: 10px; background: #fff3cd; color: #856404; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffeeba; }
        .list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { padding: 2px 8px; border-radius: 10px; font-size: 12px; background: #eee; }
    </style>
</head>
<body>
    <h1>ğŸŸï¸ Turnuva BaÅŸhakem Paneli</h1>

    <div class="flex">
        <div class="column">
            <div class="card">
                <h3>ğŸ‘¥ Oyuncu Onay Listesi</h3>
                <div id="oyuncuListesi">YÃ¼kleniyor...</div>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <h3>ğŸ“š Kelime Havuzu</h3>
                <div id="kelimeUyari" class="alert">Yeterli kelime olup olmadÄ±ÄŸÄ± hesaplanÄ±yor...</div>
                <div class="flex" style="margin-bottom:10px;">
                    <input id="k" placeholder="Kelime" style="padding:10px; flex:1;">
                    <input id="a" placeholder="Ä°pucu" style="padding:10px; flex:1;">
                    <button class="btn-green" onclick="ekle()">EKLE</button>
                </div>
                <div id="kelimeHavuzu" style="max-height:200px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div class="card" style="text-align:center;">
        <button class="btn-blue" style="font-size:1.3em; padding:20px 40px;" onclick="eslestir()">âš”ï¸ TURU BAÅLAT (Her Gruba FarklÄ± Kelimeler)</button>
        <button class="btn-red" onclick="sifirla()">SÄ°STEMÄ° SIFIRLA</button>
    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
            authDomain: "kelime-avi-bec9f.firebaseapp.com",
            databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
            projectId: "kelime-avi-bec9f",
            storageBucket: "kelime-avi-bec9f.appspot.com",
            messagingSenderId: "154681825331",
            appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        var onayliSayisi = 0;
        var havuzSayisi = 0;

        // 1. OYUNCULARI DÄ°NLE VE ONAY SÄ°STEMÄ°
        db.ref("turnuva/oyuncular").on("value", s => {
            var html = ""; onayliSayisi = 0;
            s.forEach(o => {
                var d = o.val();
                if(d.durum !== "elendi") {
                    if(d.durum === "bekliyor") onayliSayisi++;
                    html += `<div class="list-item">
                        <span>${d.ad} <span class="tag">${d.durum}</span></span>
                        ${d.durum === 'onay_bekliyor' ? `<button class='btn-green' onclick="onayla('${o.key}')">Onayla</button>` : ''}
                    </div>`;
                }
            });
            document.getElementById("oyuncuListesi").innerHTML = html;
            ihtiyacHesapla();
        });

        function onayla(id) { db.ref("turnuva/oyuncular/"+id+"/durum").set("bekliyor"); }

        // 2. KELÄ°ME HAVUZU VE ANALÄ°Z
        function ekle() {
            var k = document.getElementById("k").value.toUpperCase().trim();
            var a = document.getElementById("a").value.trim();
            if(k && a) { db.ref("turnuva/havuz").push({k, a}); document.getElementById("k").value=""; document.getElementById("a").value=""; }
        }

        db.ref("turnuva/havuz").on("value", s => {
            havuzSayisi = s.numChildren();
            var html = "";
            s.forEach(h => {
                html += `<div class="list-item">${h.val().k} <button class="btn-red" style="padding:2px 5px" onclick="db.ref('turnuva/havuz/${h.key}').remove()">X</button></div>`;
            });
            document.getElementById("kelimeHavuzu").innerHTML = html;
            ihtiyacHesapla();
        });

        function ihtiyacHesapla() {
            var macSayisi = Math.floor(onayliSayisi / 2);
            var gerekenKelime = macSayisi * 3;
            var uyari = document.getElementById("kelimeUyari");
            if(macSayisi === 0) {
                uyari.innerHTML = "â„¹ï¸ En az 2 oyuncu onaylamalÄ±sÄ±n.";
            } else if(havuzSayisi < gerekenKelime) {
                uyari.innerHTML = `âš ï¸ <b>${macSayisi} dÃ¼ello</b> iÃ§in yetersiz kelime! <br> Gereken: ${gerekenKelime}, Mevcut: ${havuzSayisi}. LÃ¼tfen <b>${gerekenKelime - havuzSayisi}</b> tane daha ekle.`;
                uyari.style.background = "#fff3cd";
            } else {
                uyari.innerHTML = `âœ… <b>${macSayisi} dÃ¼ello</b> iÃ§in her ÅŸey hazÄ±r! Her gruba farklÄ± 3 kelime gidecek.`;
                uyari.style.background = "#d4edda";
            }
        }

        // 3. EÅLEÅTÄ°RME VE FARKLI KELÄ°ME DAÄITIMI
        function eslestir() {
            db.ref("turnuva").once("value", ts => {
                var havuz = [];
                ts.child("havuz").forEach(h => { havuz.push(h.val()); });
                
                // Havuzu karÄ±ÅŸtÄ±r
                havuz = havuz.sort(() => 0.5 - Math.random());

                var bekleyenler = [];
                ts.child("oyuncular").forEach(o => { 
                    if(o.val().durum === "bekliyor") bekleyenler.push({id: o.key, ad: o.val().ad}); 
                });

                if(bekleyenler.length < 2) return alert("EÅŸleÅŸecek oyuncu yok!");
                if(havuz.length < (Math.floor(bekleyenler.length/2) * 3)) return alert("Kelime havuzu yetersiz!");

                var kelimeIndex = 0;
                for(let i=0; i < bekleyenler.length; i+=2) {
                    if(bekleyenler[i+1]) {
                        var p1 = bekleyenler[i], p2 = bekleyenler[i+1];
                        
                        // Bu maÃ§ iÃ§in sÄ±radaki 3 kelimeyi al
                        var macKelimeleri = havuz.slice(kelimeIndex, kelimeIndex + 3).map(x => ({
                            k: x.k, i: x.a, gizli: x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g, "-")
                        }));
                        kelimeIndex += 3;

                        var mid = db.ref("turnuva/maclar").push().key;
                        db.ref("turnuva/maclar/"+mid).set({
                            p1: p1.id, p2: p2.id, p1_ad: p1.ad, p2_ad: p2.ad,
                            kelimeler: macKelimeleri, aktifRaunt: 0, p1_skor: 0, p2_skor: 0, durum: "aktif", winner: ""
                        });
                        db.ref("turnuva/oyuncular/"+p1.id+"/durum").set("eslesti");
                        db.ref("turnuva/oyuncular/"+p2.id+"/durum").set("eslesti");
                    }
                }
            });
        }

        function sifirla() { if(confirm("SÄ±fÄ±rlansÄ±n mÄ±?")) db.ref("turnuva").remove(); location.reload(); }
    </script>
</body>
</html>
