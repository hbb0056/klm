<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>YÃ¶netim Paneli - Turnuva Modu</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .flex { display: flex; gap: 20px; }
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin: 5px 2px; }
        .btn-blue { background: #3498db; } .btn-green { background: #2ecc71; } .btn-red { background: #e74c3c; } .btn-purple { background: #9b59b6; }
        .list { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fff; }
        .score-item { background: #2c3e50; color: white; padding: 10px; margin-bottom: 5px; border-radius: 6px; }
        input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ† Turnuva YÃ¶netim Merkezi</h2>
        <button class="btn-blue" onclick="baslat('grup')">1ï¸âƒ£ GRUP AÅAMASINI BAÅLAT</button>
        <button class="btn-purple" onclick="ustTuraGec()">2ï¸âƒ£ ÃœST TURA GEÃ‡ (Grupta Ä°lk 2 KalÄ±r)</button>
        <button class="btn-red" onclick="db.ref('turnuva/maclar').remove()">â¹ï¸ MAÃ‡LARI DURDUR</button>
        <button style="background:black" onclick="if(confirm('Her ÅŸey sÄ±fÄ±rlanacak!')) db.ref('turnuva').remove()">ğŸ§¹ SÄ°STEMÄ° SIFIRLA</button>
        <br><br>
        Kelime: <input type="number" id="kAdet" value="5" style="width:50px"> | 
        HÄ±z (sn): <input type="number" id="hiz" value="10" style="width:50px">
    </div>

    <div class="flex">
        <div class="card" style="flex:1">
            <h3>ğŸ“Š CanlÄ± Skorlar</h3>
            <div id="canliSkorlar" class="list"></div>
        </div>
        <div class="card" style="flex:1">
            <h3>ğŸ‘¥ OnaylÄ± Ã–ÄŸrenciler (<span id="count">0</span>)</h3>
            <div id="onayListesi" class="list"></div>
        </div>
        <div class="card" style="flex:1">
            <h3>ğŸ“š Kelime Havuzu</h3>
            <input id="k" placeholder="Kelime" style="width:80px"> <input id="a" placeholder="Ä°pucu" style="width:80px">
            <button class="btn-green" onclick="kelimeEkle()">+</button>
            <div id="havuzListesi" class="list" style="margin-top:10px"></div>
        </div>
    </div>

    <script>
        var firebaseConfig = { apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4", authDomain: "kelime-avi-bec9f.firebaseapp.com", databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com", projectId: "kelime-avi-bec9f", storageBucket: "kelime-avi-bec9f.appspot.com", messagingSenderId: "154681825331", appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46" };
        firebase.initializeApp(firebaseConfig); var db = firebase.database();

        // KELÄ°ME YÃ–NETÄ°MÄ°
        function kelimeEkle() {
            var k = document.getElementById("k").value.toUpperCase().trim(), a = document.getElementById("a").value.trim();
            if(k && a) db.ref("turnuva/havuz").push({k, a});
            document.getElementById("k").value = ""; document.getElementById("a").value = "";
        }
        db.ref("turnuva/havuz").on("value", s => {
            var h = ""; s.forEach(x => { h += `<div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>${x.val().k}</span> <button class="btn-red" style="padding:2px 5px" onclick="db.ref('turnuva/havuz/${x.key}').remove()">X</button></div>`; });
            document.getElementById("havuzListesi").innerHTML = h;
        });

        // Ã–ÄRENCÄ° YÃ–NETÄ°MÄ°
        db.ref("turnuva/oyuncular").on("value", s => {
            var h = ""; window.onaylilar = [];
            s.forEach(o => {
                var d = o.val();
                if(d.durum === "onay_bekliyor") h += `<div>${d.ad} <button class="btn-green" onclick="db.ref('turnuva/oyuncular/${o.key}/durum').set('bekliyor')">Onayla</button></div>`;
                else { h += `<div>${d.ad} âœ…</div>`; window.onaylilar.push({id:o.key, ad:d.ad}); }
            });
            document.getElementById("onayListesi").innerHTML = h;
            document.getElementById("count").innerText = window.onaylilar.length;
        });

        // OYUN BAÅLATMA MANTIÄI
        function baslat() {
            db.ref("turnuva/havuz").once("value", hs => {
                if(!hs.exists() || hs.numChildren() < 1) return alert("Ã–nce kelime ekleyin!");
                var havuz = []; hs.forEach(x => havuz.push(x.val())); 
                havuz.sort(() => 0.5 - Math.random());
                var kels = havuz.slice(0, document.getElementById("kAdet").value).map(x => ({k:x.k, i:x.a, gizli:x.k.replace(/[A-ZÃ‡ÄÄ°Ã–ÅÃœ]/g,"-")}));
                
                var l = window.onaylilar.sort(() => 0.5 - Math.random());
                db.ref("turnuva/maclar").remove();

                if(l.length === 2) {
                    // SADECE 2 KÄ°ÅÄ° VARSA DÃœELLO MODU
                    db.ref("turnuva/maclar/FINAL").set({
                        tip: "duello", durum: "aktif", kelimeler: kels,
                        skorlar: { [l[0].ad]: 0, [l[1].ad]: 0 },
                        ilerleme: { [l[0].ad]: 0, [l[1].ad]: 0 }
                    });
                    l.forEach(x => db.ref("turnuva/oyuncular/"+x.id).update({durum:"eslesti", takim:x.ad}));
                } else {
                    // GRUP MODU (4'erli)
                    for(let i=0; i < Math.ceil(l.length/4); i++) {
                        let grup = l.slice(i*4, (i*4)+4), sk = {}, il = {};
                        grup.forEach(x => { sk[x.ad] = 0; il[x.ad] = 0; db.ref("turnuva/oyuncular/"+x.id).update({durum:"eslesti", takim:x.ad}); });
                        db.ref("turnuva/maclar/Grup-"+(i+1)).set({ tip:"grup", durum:"aktif", kelimeler:kels, skorlar:sk, ilerleme:il });
                    }
                }
                motor();
            });
        }

        // HARF AÃ‡MA MOTORU
        function motor() {
            var hz = document.getElementById("hiz").value; if(window.mtr) clearInterval(window.mtr);
            window.mtr = setInterval(() => {
                db.ref("turnuva/maclar").once("value", s => { s.forEach(ms => {
                    var m = ms.val(); if(m.durum === "aktif") {
                        m.kelimeler.forEach((kel, idx) => {
                            var t = []; for(let i=0; i<kel.gizli.length; i++) if(kel.gizli[i]==="-") t.push(i);
                            if(t.length > 1) {
                                var sIndex = t[Math.floor(Math.random()*t.length)];
                                var yeniGizli = kel.gizli.split(""); yeniGizli[sIndex] = kel.k[sIndex];
                                db.ref(`turnuva/maclar/${ms.key}/kelimeler/${idx}/gizli`).set(yeniGizli.join(""));
                            }
                        });
                    }
                }); });
            }, hz * 1000);
        }

        // ELEME MANTIÄI (TOP 2)
        async function ustTuraGec() {
            if(!confirm("Her gruptan en yÃ¼ksek puanlÄ± 2 kiÅŸi kalacak. DiÄŸerleri elenecek?")) return;
            const snap = await db.ref("turnuva/maclar").once("value");
            let kazananlar = [];
            snap.forEach(m => {
                let siralama = Object.entries(m.val().skorlar).sort((a,b) => b[1] - a[1]);
                if(siralama[0]) kazananlar.push(siralama[0][0]);
                if(siralama[1]) kazananlar.push(siralama[1][0]);
            });
            window.onaylilar.forEach(o => {
                if(!kazananlar.includes(o.ad)) db.ref("turnuva/oyuncular/"+o.id).remove();
                else db.ref("turnuva/oyuncular/"+o.id).update({durum:"bekliyor"});
            });
            alert("Elenenler Ã§Ä±karÄ±ldÄ±. Kalan kiÅŸi sayÄ±sÄ±: " + kazananlar.length);
        }

        // SKOR TAKÄ°BÄ°
        db.ref("turnuva/maclar").on("value", s => {
            var h = ""; s.forEach(m => {
                var v = m.val(); h += `<div class="score-item"><b>${m.key}</b><br>`;
                for(let t in v.skorlar) h += `<small>${t}: ${v.skorlar[t]} Puan (Soru: ${v.ilerleme[t] + 1})</small><br>`;
                h += `</div>`;
            });
            document.getElementById("canliSkorlar").innerHTML = h || "Bekleniyor...";
        });
    </script>
</body>
</html>
