<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
</head>
<body>

<h2>Admin Panel</h2>

<h3>Onay Bekleyenler</h3>
<div id="waitingList"></div>

<h3>Kelime Havuzu</h3>
<input type="text" id="wordInput" placeholder="Kelime">
<input type="text" id="hintInput" placeholder="İpucu">
<button onclick="addWord()">Ekle</button>
<div id="wordList"></div>

<h3>Ayarlar</h3>
<label>Her aşamada kaç kelime sorulsun?</label>
<input type="number" id="wordsPerRound" value="3">
<label>Harf açılma süresi (sn)</label>
<input type="number" id="letterTime" value="2">
<button onclick="saveSettings()">Kaydet</button>

<h3>Gruplar Oluştur</h3>
<input type="number" id="groupCount" placeholder="Kaç Grup?">
<button onclick="createGroups()">Grupları Kur</button>
<div id="groupsList"></div>

<h3>Turnuva Yönetimi</h3>
<button onclick="calculateGroupWinners()">Grup Kazananlarını Seç</button>
<button onclick="createQuarterFinal()">Çeyrek Final Oluştur</button>
<button onclick="createSemiFinal()">Yarı Final Oluştur</button>
<button onclick="createFinal()">Final Oluştur</button>
<button onclick="declareChampion()">Şampiyonu Belirle</button>

<h3>Eşleşmeler</h3>
<div id="matchesList"></div>

<h3>Üst Turda Kimler Var?</h3>
<div id="quarterPlayers"></div>
<div id="semiPlayers"></div>
<div id="finalPlayers"></div>

<div id="championDiv"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
  authDomain: "kelime-avi-bec9f.firebaseapp.com",
  databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
  projectId: "kelime-avi-bec9f",
  storageBucket: "kelime-avi-bec9f.firebasestorage.app",
  messagingSenderId: "154681825331",
  appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// Waiting list
db.ref("waitingPlayers").on("child_added", function(snapshot){
  var data = snapshot.val();
  var id = snapshot.key;
  document.getElementById("waitingList").innerHTML +=
    data.name+" <button onclick=\"approve('"+id+"','"+data.name+"')\">Onayla</button><br>";
});

function approve(id,name){
  db.ref("players").push({name:name,score:0});
  db.ref("waitingPlayers/"+id).remove();
}

// Oyuncuları göster
db.ref("players").on("value", function(snapshot){
  var html="";
  snapshot.forEach(function(child){
    html+=child.val().name+" - "+(child.val().score||0)+" puan<br>";
  });
  document.getElementById("playersList").innerHTML=html;
});

// Kelime havuzu ekle
function addWord(){
  var word=document.getElementById("wordInput").value.toUpperCase();
  var hint=document.getElementById("hintInput").value;
  if(word==""||hint=="") return;
  db.ref("words").push({word:word,hint:hint});
  document.getElementById("wordInput").value="";
  document.getElementById("hintInput").value="";
}

// Kelime havuzunu göster
db.ref("words").on("value", function(snapshot){
  var html="";
  snapshot.forEach(function(child){
    html+=child.val().word+" - "+child.val().hint+"<br>";
  });
  document.getElementById("wordList").innerHTML=html;
});

// Ayarları kaydet
function saveSettings(){
  var words=parseInt(document.getElementById("wordsPerRound").value);
  var letterTime=parseInt(document.getElementById("letterTime").value);
  db.ref("settings").set({wordsPerRound:words,letterTime:letterTime});
}

// Shuffle
function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

// Grupları kur
function createGroups(){
  var groupCount=parseInt(document.getElementById("groupCount").value);
  db.ref("players").once("value", function(snapshot){
    var players=[];
    snapshot.forEach(function(child){
      players.push({id:child.key,name:child.val().name,score:child.val().score});
    });
    players=shuffle(players);
    var groups={};
    for(let i=0;i<groupCount;i++) groups[String.fromCharCode(65+i)]=[];
    for(let i=0;i<players.length;i++){
      var g=Object.keys(groups)[i%groupCount];
      groups[g].push(players[i]);
    }
    db.ref("groups").set(groups);
    db.ref("stage").set("group");
  });
}

// Grupları göster
db.ref("groups").on("value", function(snapshot){
  var html="";
  snapshot.forEach(function(group){
    html+="<b>Grup "+group.key+"</b><br>";
    group.forEach(function(player){ html+=player.val().name+"<br>"; });
    html+="<br>";
  });
  document.getElementById("groupsList").innerHTML=html;
});

// Grup kazananlarını seç
function calculateGroupWinners(){
  db.ref("groups").once("value", function(snapshot){
    var qualified=[];
    snapshot.forEach(function(group){
      var arr=[];
      group.forEach(function(player){ arr.push(player.val()); });
      arr.sort((a,b)=>b.score-b.score);
      if(arr[0]) qualified.push(arr[0]);
      if(arr[1]) qualified.push(arr[1]);
    });
    db.ref("qualified").set(qualified);
    db.ref("stage").set("quarter");
  });
}

// Çeyrek Final
function createQuarterFinal(){
  db.ref("qualified").once("value", function(snapshot){
    var players=snapshot.val();
    players=shuffle(players);
    var matches=[];
    for(let i=0;i<players.length;i+=2){
      matches.push({player1:players[i],player2:players[i+1],winner:null});
    }
    db.ref("quarterFinal").set(matches);
    db.ref("stage").set("quarter");
  });
}

// Yarı Final
function createSemiFinal(){
  db.ref("quarterFinal").once("value", function(snapshot){
    var winners=[];
    snapshot.forEach(function(match){
      if(match.val().winner) winners.push(match.val().winner);
    });
    winners=shuffle(winners);
    var matches=[];
    for(let i=0;i<winners.length;i+=2){
      matches.push({player1:winners[i],player2:winners[i+1],winner:null});
    }
    db.ref("semiFinal").set(matches);
    db.ref("stage").set("semi");
  });
}

// Final
function createFinal(){
  db.ref("semiFinal").once("value", function(snapshot){
    var winners=[];
    snapshot.forEach(function(match){
      if(match.val().winner) winners.push(match.val().winner);
    });
    db.ref("final").set({player1:winners[0],player2:winners[1],winner:null});
    db.ref("stage").set("final");
  });
}

// Şampiyon
function declareChampion(){
  db.ref("final").once("value", function(snapshot){
    var f=snapshot.val();
    if(f.winner){
      db.ref("champion").set(f.winner);
      db.ref("stage").set("finished");
    }
  });
}

// Üst turları göster
function updateQualifiedDisplays(){
  db.ref("quarterFinal").once("value", function(snapshot){
    var html="";
    if(snapshot.val()) snapshot.forEach(function(match){
      if(match.val().winner) html+=match.val().winner.name+"<br>";
    });
    document.getElementById("quarterPlayers").innerHTML=html;
  });
  db.ref("semiFinal").once("value", function(snapshot){
    var html="";
    if(snapshot.val()) snapshot.forEach(function(match){
      if(match.val().winner) html+=match.val().winner.name+"<br>";
    });
    document.getElementById("semiPlayers").innerHTML=html;
  });
  db.ref("final").once("value", function(snapshot){
    var f=snapshot.val();
    if(f){
      var html="";
      if(f.player1) html+=f.player1.name+"<br>";
      if(f.player2) html+=f.player2.name+"<br>";
      document.getElementById("finalPlayers").innerHTML=html;
    }
  });
}

setInterval(updateQualifiedDisplays,2000);
</script>

</body>
</html>
