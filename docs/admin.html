<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body{
      background:black;
      color:white;
      font-family:Arial;
      padding:20px;
    }
    button{
      margin:5px;
      padding:5px 10px;
    }
    .groupBox{
      border:1px solid white;
      padding:10px;
      margin:10px 0;
    }
  </style>
</head>
<body>

<h2>ADMIN PANEL</h2>

<h3>Onay Bekleyenler</h3>
<div id="waitingList"></div>

<h3>Onaylanan Oyuncular</h3>
<div id="playerList"></div>

<h3>Turnuva</h3>
<button onclick="startTournament()">Turnuvayı Başlat</button>
<button onclick="playGroupMatches()">Grup Maçlarını Oynat</button>

<div id="groupsArea"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
  authDomain: "kelime-avi-bec9f.firebaseapp.com",
  databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
  projectId: "kelime-avi-bec9f",
  storageBucket: "kelime-avi-bec9f.firebasestorage.app",
  messagingSenderId: "154681825331",
  appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();


// ONAY BEKLEYENLER
db.ref("waiting").on("value", snapshot => {
  let html = "";
  snapshot.forEach(child => {
    html += child.val().name +
      " <button onclick=\"approve('" + child.key + "','" + child.val().name + "')\">Onayla</button><br>";
  });
  document.getElementById("waitingList").innerHTML = html;
});

function approve(id, name){
  db.ref("players").push({
    name: name,
    points: 0
  });
  db.ref("waiting/" + id).remove();
}


// OYUNCULAR
db.ref("players").on("value", snapshot => {
  let html = "";
  snapshot.forEach(child => {
    html += child.val().name + "<br>";
  });
  document.getElementById("playerList").innerHTML = html;
});


// GRUP OLUŞTUR
function startTournament(){

  db.ref("players").once("value", snapshot => {

    let players = [];

    snapshot.forEach(child => {
      players.push({
        id: child.key,
        name: child.val().name,
        points: 0
      });
    });

    if(players.length < 2){
      alert("En az 2 oyuncu gerekli");
      return;
    }

    db.ref("tournament/groups").remove();

    let groupNumber = 1;

    for(let i = 0; i < players.length; i += 4){
      let groupPlayers = players.slice(i, i + 4);
      db.ref("tournament/groups/group" + groupNumber).set(groupPlayers);
      groupNumber++;
    }

  });
}


// GRUP MAÇLARINI OTOMATİK OYNAT
function playGroupMatches(){

  db.ref("tournament/groups").once("value", snapshot => {

    snapshot.forEach(groupSnap => {

      let group = [];
      groupSnap.forEach(player => {
        group.push(player.val());
      });

      // herkes herkesle oynar
      for(let i=0; i<group.length; i++){
        for(let j=i+1; j<group.length; j++){

          let result = Math.random();

          if(result < 0.4){
            group[i].points += 3;
          }
          else if(result < 0.8){
            group[j].points += 3;
          }
          else{
            group[i].points += 1;
            group[j].points += 1;
          }
        }
      }

      db.ref("tournament/groups/" + groupSnap.key).set(group);

    });

  });

}


// GRUPLARI GÖSTER
db.ref("tournament/groups").on("value", snapshot => {

  let html = "";
  let gNo = 1;

  snapshot.forEach(group => {

    let players = [];

    group.forEach(p => {
      players.push(p.val());
    });

    players.sort((a,b)=>b.points - a.points);

    html += "<div class='groupBox'><b>Grup " + gNo + "</b><br>";

    players.forEach(p=>{
      html += p.name + " - " + p.points + " puan<br>";
    });

    html += "</div>";

    gNo++;
  });

  document.getElementById("groupsArea").innerHTML = html;

});
</script>

</body>
</html>
