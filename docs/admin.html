<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body{
      background:black;
      color:white;
      font-family:Arial;
      padding:20px;
    }
    button{
      margin:5px;
      padding:5px 10px;
    }
    .box{
      border:1px solid white;
      padding:10px;
      margin:10px 0;
    }
  </style>
</head>
<body>

<h2>ADMIN PANEL</h2>

<h3>Onay Bekleyenler</h3>
<div id="waitingList"></div>

<h3>Onaylanan Oyuncular</h3>
<div id="playerList"></div>

<h3>Turnuva</h3>
<button onclick="startTournament()">Turnuvayı Başlat</button>
<button onclick="playGroupMatches()">Grup Maçlarını Oynat</button>
<button onclick="createQuarterFinals()">Çeyrek Finalleri Oluştur</button>

<div id="groupsArea"></div>
<div id="quarterArea"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBwzlkq9LZYCM_sk_M6tKfx5jme37Zw0u4",
  authDomain: "kelime-avi-bec9f.firebaseapp.com",
  databaseURL: "https://kelime-avi-bec9f-default-rtdb.firebaseio.com",
  projectId: "kelime-avi-bec9f",
  storageBucket: "kelime-avi-bec9f.firebasestorage.app",
  messagingSenderId: "154681825331",
  appId: "1:154681825331:web:7c8fec41e0d8ee2664eb46"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();


// ONAY
db.ref("waiting").on("value", snapshot => {
  let html="";
  snapshot.forEach(child=>{
    html+=child.val().name+
    " <button onclick=\"approve('"+child.key+"','"+child.val().name+"')\">Onayla</button><br>";
  });
  document.getElementById("waitingList").innerHTML=html;
});

function approve(id,name){
  db.ref("players").push({name:name,points:0});
  db.ref("waiting/"+id).remove();
}

db.ref("players").on("value", snapshot=>{
  let html="";
  snapshot.forEach(child=>{
    html+=child.val().name+"<br>";
  });
  document.getElementById("playerList").innerHTML=html;
});


// GRUP OLUŞTUR
function startTournament(){

  db.ref("players").once("value", snapshot=>{

    let players=[];
    snapshot.forEach(child=>{
      players.push({name:child.val().name,points:0});
    });

    let total = players.length;

    if(total < 3){
      alert("En az 3 oyuncu gerekli");
      return;
    }

    db.ref("tournament/groups").remove();

    let groups=[];
    let i=0;

    while(total - i > 0){

      let remaining = total - i;

      if(remaining == 5){
        groups.push(players.slice(i,i+3));
        groups.push(players.slice(i+3,i+5));
        break;
      }

      if(remaining == 2){
        groups[groups.length-1] = 
          groups[groups.length-1].concat(players.slice(i,i+2));
        break;
      }

      if(remaining >= 4){
        groups.push(players.slice(i,i+4));
        i+=4;
      }else{
        groups.push(players.slice(i,i+3));
        break;
      }
    }

    groups.forEach((group,index)=>{
      db.ref("tournament/groups/group"+(index+1)).set(group);
    });

  });
}

// GRUP MAÇLARI
function playGroupMatches(){
  db.ref("tournament/groups").once("value", snapshot=>{
    snapshot.forEach(groupSnap=>{
      let group=[];
      groupSnap.forEach(p=>group.push(p.val()));

      for(let i=0;i<group.length;i++){
        for(let j=i+1;j<group.length;j++){
          let r=Math.random();
          if(r<0.5){
            group[i].points+=3;
          }else{
            group[j].points+=3;
          }
        }
      }

      db.ref("tournament/groups/"+groupSnap.key).set(group);
    });
  });
}


// GRUP GÖSTER
db.ref("tournament/groups").on("value", snapshot=>{
  let html="";
  snapshot.forEach((group,index)=>{
    let players=[];
    group.forEach(p=>players.push(p.val()));
    players.sort((a,b)=>b.points-a.points);

    html+="<div class='box'><b>Grup</b><br>";
    players.forEach(p=>{
      html+=p.name+" - "+p.points+" puan<br>";
    });
    html+="</div>";
  });
  document.getElementById("groupsArea").innerHTML=html;
});


// ÇEYREK FİNAL OLUŞTUR
function createQuarterFinals(){

  db.ref("tournament/groups").once("value", snapshot=>{

    let qualified=[];

    snapshot.forEach(groupSnap=>{
      let players=[];
      groupSnap.forEach(p=>players.push(p.val()));
      players.sort((a,b)=>b.points-a.points);

      if(players.length>=2){
        qualified.push(players[0]);
        qualified.push(players[1]);
      }
    });

    db.ref("tournament/quarter").remove();

    for(let i=0;i<qualified.length;i+=2){
      db.ref("tournament/quarter/match"+(i/2+1)).set({
        player1: qualified[i]?.name || "",
        player2: qualified[i+1]?.name || ""
      });
    }

  });

}


// ÇEYREK GÖSTER
db.ref("tournament/quarter").on("value", snapshot=>{
  let html="<h3>Çeyrek Finaller</h3>";
  snapshot.forEach(match=>{
    html+=match.val().player1+" vs "+match.val().player2+"<br>";
  });
  document.getElementById("quarterArea").innerHTML=html;
});
</script>

</body>
</html>
